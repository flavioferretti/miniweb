.\" Copyright (c) 2026 MiniWeb Contributors
.\" BSD 3-Clause License
.\"
.Dd February 18, 2026
.Dt MINIWEB 1
.Os
.Sh NAME
.Nm miniweb
.Nd lightweight HTTP server for OpenBSD system monitoring
.Sh SYNOPSIS
.Nm
.Op Fl hv
.Op Fl b Ar address
.Op Fl c Ar connections
.Op Fl f Ar file
.Op Fl p Ar port
.Op Fl t Ar threads
.Sh DESCRIPTION
The
.Nm
utility is a lightweight HTTP server designed for OpenBSD system monitoring
and metrics collection.
It provides a web-based dashboard, a RESTful JSON API for system metrics,
and an integrated manual page browser.
.Pp
.Nm
uses a single
.Xr kqueue 2
instance managed by a dedicated dispatcher thread.
When a connection becomes read-ready, the event is delivered once
.Pq using Dv EV_DISPATCH
and the connection is placed on a work queue.
Worker threads dequeue connections, accumulate the full HTTP request,
parse it, dispatch to the appropriate handler, and close the connection.
This design avoids busy-waiting and eliminates race conditions between workers.
.Pp
.Xr pledge 2
and
.Xr unveil 2
are applied at startup to restrict the process to the minimum required
system calls and filesystem paths.
System metrics are gathered via
.Xr sysctl 2
without spawning external processes.
Manual page rendering delegates to
.Xr mandoc 1
via a subprocess with an enforced timeout.
.Pp
.Nm
does not implement TLS directly.
For production deployments, place it behind
.Xr relayd 8
for TLS termination.
See
.Sx EXAMPLES
for a working
.Xr relayd 8
configuration.
.Pp
At startup
.Nm
loads a configuration file if one is found
.Pq see Sx CONFIGURATION FILE .
Command-line flags always override file values.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl b Ar address
Bind to the specified IPv4 address.
The default is
.Cm 127.0.0.1
.Pq loopback only .
Use
.Cm 0.0.0.0
to listen on all interfaces.
When deployed behind
.Xr relayd 8 ,
the default loopback binding is recommended.
.It Fl c Ar connections
Set the maximum number of concurrent connections.
The default is
.Cm 1280 .
Connections beyond this limit receive a 503 response and are closed
immediately.
.It Fl f Ar file
Load configuration from
.Ar file
instead of searching the default locations.
If the specified file does not exist or cannot be parsed,
.Nm
exits with an error.
See
.Sx CONFIGURATION FILE
for the file format and default search order.
.It Fl h
Print a usage summary and exit.
.It Fl p Ar port
Listen on the specified TCP port.
The default is
.Cm 9001 .
Ports below 1024 require root privileges.
.It Fl t Ar threads
Set the number of worker threads.
The default is
.Cm 4 .
Each worker independently dequeues and processes connections.
A value matching the CPU core count is a reasonable starting point.
The maximum is
.Cm 4
as compiled; recompile with a higher
.Dv THREAD_POOL_SIZE
to increase it.
.It Fl v
Enable verbose logging to standard error.
Logs include connection accept/close events, worker dispatch, and
security initialisation details.
.El
.Sh ENDPOINTS
.Nm
provides the following HTTP endpoints.
All responses use
.Cm Connection: close ;
persistent connections are not supported.
.Ss Web Interface
.Bl -tag -width Ds
.It Pa /
Main dashboard with system overview.
Tabbed navigation covers load averages, memory, disk, network interfaces,
and process information.
.It Pa /docs
Manual page browser with search powered by
.Xr apropos 1 .
.It Pa /networking
Network interface overview including routes and DNS configuration.
.It Pa /apiroot
API index page listing available endpoints and their response formats.
.El
.Ss Metrics API
.Bl -tag -width Ds
.It Pa /api/metrics
Returns a JSON object with the following fields:
.Bl -bullet -compact
.It
System information: hostname, OS version, uptime, architecture.
.It
CPU load averages: 1, 5, and 15 minute.
.It
Memory: total, free, active, wired, cached pages.
.It
Swap usage.
.It
Disk usage for all mounted filesystems.
.It
Network interface status and assigned addresses.
.It
Top 10 processes by CPU usage.
.It
Top 10 processes by memory usage.
.It
Process counts: total, running, sleeping, zombie.
.El
.Pp
Metrics are cached to reduce
.Xr sysctl 2
call overhead.
.It Pa /api/networking
Returns a JSON object with network interface details,
routing table entries, and DNS resolver configuration.
.El
.Ss Manual Page API
.Bl -tag -width "/api/man/search"
.It Pa /api/man/search
Accepts a
.Cm ?q=
query parameter and returns raw
.Xr apropos 1
output, one entry per line.
Unlike other API endpoints, the response content type is
.Cm text/plain
to simplify line-based parsing in the frontend.
.It Pa /man/ Ns Ar area Ns / Ns Ar section Ns / Ns Ar page Ns Op Ar .ext
Renders a manual page via
.Xr mandoc 1 .
Supported extensions and their output formats:
.Pp
.Bl -tag -width ".html" -compact
.It Cm .html
HTML output
.Pq default if no extension is given .
.It Cm .txt
Plain text.
.It Cm .md
Markdown.
.It Cm .pdf
PDF.
.It Cm .ps
PostScript.
.El
.El
.Ss Static Files
.Bl -tag -width Ds
.It Pa /static/ Ns Ar path
Serves static assets including CSS, JavaScript, and images.
The path component is validated to reject
.Sq ..
and
.Sq //
sequences.
Files are served from the
.Pa static/
directory relative to the working directory.
.It Pa /favicon.ico
Serves the site favicon from
.Pa static/assets/favicon.svg
as
.Cm image/svg+xml .
.El
.Sh REVERSE PROXY
.Nm
is designed to run behind
.Xr relayd 8 .
When a reverse proxy is present,
.Nm
reads the following request headers to determine the real client
address and original protocol:
.Bl -tag -width "X-Forwarded-Proto" -compact
.It Cm X-Real-IP
Preferred header for the client IP address.
.It Cm X-Forwarded-For
Used if
.Cm X-Real-IP
is absent; the first comma-separated value is taken.
.It Cm X-Forwarded-Proto
Set to
.Cm https
by
.Xr relayd 8
to indicate that the original connection used TLS.
.El
.Pp
If none of these headers are present, the peer address of the TCP
connection is used.
.Pp
These headers should be set exclusively by the reverse proxy and must
not be accepted from untrusted clients.
Configure
.Xr relayd 8
to overwrite rather than append them.
.Sh CONFIGURATION FILE
.Nm
reads a configuration file at startup before applying command-line flags.
The file is searched in the following order; the first match is used:
.Bl -enum -compact
.It
Path supplied with
.Fl f Ar file
.Pq explicit, failure is fatal .
.It
.Pa ./miniweb.conf
.Pq current working directory .
.It
.Pa $HOME/.miniweb.conf
.It
.Pa /etc/miniweb.conf
.El
.Pp
If no file is found, compiled-in defaults are used.
Command-line flags always take precedence over file values.
.Pp
The file format is one directive per line:
.Bd -literal -offset indent
key    value
.Ed
.Pp
Lines beginning with
.Sq #
are comments.
Blank lines are ignored.
Keys are case-insensitive.
.Pp
Recognised directives:
.Bl -tag -width "mandoc_timeout"
.It Cm port Ar n
TCP port to listen on.
Range 1\(en65535.
Default:
.Cm 9001 .
.It Cm bind Ar address
IPv4 address to bind to.
Default:
.Cm 127.0.0.1 .
.It Cm threads Ar n
Number of worker threads.
Range 1\(en64.
Default:
.Cm 4 .
.It Cm max_conns Ar n
Maximum concurrent connections.
Range 1\(en65535.
Default:
.Cm 1280 .
.It Cm conn_timeout Ar seconds
Idle connection timeout.
Range 1\(en3600.
Default:
.Cm 30 .
.It Cm max_req_size Ar bytes
Maximum HTTP request size in bytes.
Range 1024\(en1048576.
Default:
.Cm 16384 .
.It Cm mandoc_timeout Ar seconds
Timeout for
.Xr mandoc 1
subprocess invocations.
Range 1\(en120.
Default:
.Cm 10 .
.It Cm static_dir Ar path
Directory from which static assets are served.
Default:
.Cm static .
.It Cm templates_dir Ar path
Directory containing HTML templates.
Default:
.Cm templates .
.It Cm mandoc_path Ar path
Absolute path to the
.Xr mandoc 1
binary.
Default:
.Cm /usr/bin/mandoc .
.It Cm trusted_proxy Ar address
IPv4 address of the reverse proxy from which
.Cm X-Forwarded-For ,
.Cm X-Forwarded-Proto ,
and
.Cm X-Real-IP
headers are accepted.
Default:
.Cm 127.0.0.1 .
.It Cm verbose Ar bool
Enable verbose logging.
Accepted values:
.Cm yes ,
.Cm no ,
.Cm true ,
.Cm false ,
.Cm 1 ,
.Cm 0 .
Default:
.Cm no .
.El
.Pp
Unknown directives produce a warning on standard error but do not abort startup.
.Sh FILES
.Bl -tag -width "templates/" -compact
.It Pa ./miniweb.conf
.It Pa $HOME/.miniweb.conf
.It Pa /etc/miniweb.conf
Configuration files searched in order at startup.
See
.Sx CONFIGURATION FILE .
.It Pa templates/
HTML templates for dashboard and documentation pages.
Must be unveiled read-only.
.It Pa static/
Static assets served under
.Pa /static/ .
Must be unveiled read-only.
.It Pa /etc/passwd
Consulted for user name lookups in process listings.
Unveiled for
.Xr getpwuid 3 .
.It Pa /etc/group
Consulted for group name lookups.
Unveiled read-only.
.It Pa /etc/resolv.conf
Read for DNS resolver configuration displayed on the networking page.
Unveiled read-only.
.It Pa /etc/man.conf
Read by
.Xr mandoc 1
at startup.
.It Pa /usr/share/man
.It Pa /usr/local/man
.It Pa /usr/X11R6/man
Manual page directories.
All three are unveiled read-only.
.It Pa /usr/bin/mandoc
Manual page formatter.
Unveiled for execution.
.It Pa /usr/bin/apropos
Used for manual page search.
Unveiled for execution.
.It Pa /bin/ps
.It Pa /usr/bin/netstat
.It Pa /bin/sh
Unveiled for execution by metric and networking collectors.
.El
.Sh EXAMPLES
Start the server on the default port with verbose logging:
.Bd -literal -offset indent
$ miniweb -v
.Ed
.Pp
Load an explicit configuration file:
.Bd -literal -offset indent
$ miniweb -f /etc/miniweb.conf
.Ed
.Pp
Override a single value from the config file on the command line:
.Bd -literal -offset indent
$ miniweb -f /etc/miniweb.conf -p 8080
.Ed
.Pp
Listen on all interfaces on port 8080 with 8 worker threads:
.Bd -literal -offset indent
$ miniweb -b 0.0.0.0 -p 8080 -t 8
.Ed
.Pp
Production configuration behind a reverse proxy,
high connection limit:
.Bd -literal -offset indent
$ miniweb -b 127.0.0.1 -p 9001 -c 1280 -t 4
.Ed
.Pp
Query the metrics endpoint directly:
.Bd -literal -offset indent
$ curl -s http://127.0.0.1:9001/api/metrics | jq .
.Ed
.Pp
Minimal
.Xr relayd 8
configuration for TLS termination.
.Xr acme-client 1
or
.Xr acme-client.conf 5
should be used to provision the certificate beforehand:
.Bd -literal -offset indent
table <miniweb> { 127.0.0.1 }

http protocol "https_proxy" {
    tls

    match request header set "X-Forwarded-For" \e
        value "$REMOTE_ADDR"
    match request header set "X-Forwarded-Proto" \e
        value "https"
    match request header set "X-Real-IP" \e
        value "$REMOTE_ADDR"
    match request header set "Host" \e
        value "$HOST"

    tcp { nodelay }
}

relay "https_frontend" {
    listen on egress port 443 tls
    protocol "https_proxy"
    forward to <miniweb> port 9001
}

relay "http_redirect" {
    listen on egress port 80
    forward to <miniweb> port 9001
}
.Ed
.Pp
Verify that all endpoints respond correctly through the proxy:
.Bd -literal -offset indent
$ for p in / /docs /apiroot /networking \e
      /api/metrics /api/networking \e
      /static/css/custom.css /favicon.ico; do
    printf '%-30s %s\en' "$p" \e
      "$(curl -sk -o /dev/null \e
         -w '%{http_code}' https://example.com$p)"
  done
.Ed
.Sh DIAGNOSTICS
.Ex -std
.Pp
The following messages may appear on standard error:
.Bl -tag -width Ds
.It Dq bind: Address already in use
Another process is listening on the specified port.
Use
.Ql fstat | grep Ar :port
to identify it.
.It Dq pledge: Operation not permitted
A system call was attempted outside the current
.Xr pledge 2
promise set.
The required promises are:
.Cm stdio rpath inet route proc exec vminfo ps getpw .
.It Dq sysctl data query failed: Cannot allocate memory
The process table is growing faster than the buffer can be resized.
.Nm
retries automatically; if the condition persists, investigate runaway
process creation.
.It Dq [write_all] Too many EAGAIN retries
The client socket buffer remained full for too many polling cycles.
The connection is dropped.
This may indicate a very slow or unresponsive client.
.It Dq Connection limit reached, rejected fd= Ns Ar n
The active connection count reached the value set by
.Fl c .
Increase the limit or reduce connection hold time.
.El
.Sh SEE ALSO
.Xr acme-client 1 ,
.Xr apropos 1 ,
.Xr curl 1 ,
.Xr mandoc 1 ,
.Xr kqueue 2 ,
.Xr pledge 2 ,
.Xr sysctl 2 ,
.Xr unveil 2 ,
.Xr getifaddrs 3 ,
.Xr getloadavg 3 ,
.Xr getmntinfo 3 ,
.Xr getpwuid 3 ,
.Xr relayd 8
.Sh STANDARDS
The HTTP implementation follows RFC 7230 through RFC 7235
.Pq HTTP/1.1 .
Only
.Cm Connection: close
is supported; persistent connections and pipelining are not implemented.
.Sh HISTORY
.Nm
was originally based on
.Nm libmicrohttpd .
In early 2026 it was rewritten to use a native
.Xr kqueue 2
dispatcher with a
.Dv EV_DISPATCH Ns -based
worker pool, removing the external library dependency and improving
throughput to over 7000 requests per second on a four-core system.
A configuration file facility was added shortly after,
replacing all hardcoded values with a runtime-configurable
.Pa miniweb.conf
read by
.Pa src/conf.c .
.Sh AUTHORS
.An MiniWeb Contributors
.Sh CAVEATS
.Nm
is OpenBSD-specific.
It depends on
.Xr kqueue 2 ,
.Xr pledge 2 ,
.Xr unveil 2 ,
and OpenBSD
.Xr sysctl 2
MIBs.
Porting to other systems requires substantial changes.
.Pp
The manual page renderer invokes
.Xr mandoc 1
as a subprocess.
Although isolated by
.Xr pledge 2
and
.Xr unveil 2 ,
the subprocess execution path represents additional attack surface.
User-supplied section, area, and page name components are sanitised
before use; only alphanumeric characters, hyphens, underscores,
periods, and plus signs are permitted.
.Pp
JSON output uses fixed-size buffers.
Extremely long hostnames, mount point paths, or process argument
lists may be silently truncated.
.Sh SECURITY CONSIDERATIONS
.Nm
implements layered security using native OpenBSD facilities:
.Bl -bullet
.It
.Xr pledge 2
restricts available system calls to those required for normal operation.
.It
.Xr unveil 2
limits filesystem access to
.Pa templates/ ,
.Pa static/ ,
the system manual page directories, and a small set of executable paths.
.It
Path traversal is rejected in the static file handler by refusing any
path containing
.Sq ..
or
.Sq //
sequences.
.It
The connection pool limits active connections and allocates each on the
heap; a connection exceeding the pool size receives a 503 response and
is closed without further processing.
.It
.Cm X-Forwarded-For
and related headers are set by
.Xr relayd 8
and must not be trusted from direct external connections.
Deploy with
.Fl b Cm 127.0.0.1
and route all external traffic through the reverse proxy.
.El
.Pp
Never expose
.Nm
directly to untrusted networks.
.Sh BUGS
Subprocess timeout handling for
.Xr mandoc 1
invocations relies on
.Xr poll 2
with a wall-clock deadline.
A kernel stall inside
.Xr mandoc 1
itself cannot be interrupted by this mechanism.
.Pp
The template engine performs token substitution without HTML escaping.
If future changes introduce user-supplied input into template rendering,
a proper escaping pass must be added.
.Pp
Only IPv4 is supported.
IPv6 requires changes to the socket creation and address handling code.
