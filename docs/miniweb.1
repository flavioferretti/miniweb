.\" Copyright (c) 2026 MiniWeb Contributors
.\" BSD 3-Clause License
.\"
.Dd February 21, 2026
.Dt MINIWEB 1
.Os
.Sh NAME
.Nm miniweb
.Nd lightweight HTTP server for OpenBSD system monitoring
.Sh SYNOPSIS
.Nm
.Op Fl hv
.Op Fl b Ar address
.Op Fl c Ar connections
.Op Fl f Ar file
.Op Fl p Ar port
.Op Fl t Ar threads
.Sh DESCRIPTION
The
.Nm
utility is a lightweight HTTP server designed for OpenBSD system monitoring
and metrics collection.
It provides a web-based dashboard, a RESTful JSON API for system metrics,
and an integrated manual page browser.
.Pp
.Nm
uses a single
.Xr kqueue 2
instance managed by a dedicated dispatcher thread.
When a connection becomes read-ready, the event is delivered once
.Pq using Dv EV_DISPATCH
and the connection is placed on a work queue.
Worker threads dequeue connections, accumulate the full HTTP request,
parse it, dispatch to the appropriate handler, and close the connection.
This design avoids busy-waiting and eliminates race conditions between workers.
.Pp
.Xr pledge 2
and
.Xr unveil 2
are applied at startup to restrict the process to the minimum required
system calls and filesystem paths.
System metrics are gathered via
.Xr sysctl 2
without spawning external processes.
Manual page rendering delegates to
.Xr mandoc 1
via a subprocess with an enforced timeout.
.Pp
.Nm
does not implement TLS directly.
For production deployments, place it behind
.Xr relayd 8
for TLS termination.
See
.Sx EXAMPLES
for a working
.Xr relayd 8
configuration.
.Pp
At startup
.Nm
loads a configuration file if one is found
.Pq see Sx CONFIGURATION FILE .
Command-line flags always override file values.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl b Ar address
Bind to the specified IPv4 address.
The default is
.Cm 127.0.0.1
.Pq loopback only .
Use
.Cm 0.0.0.0
to listen on all interfaces.
When deployed behind
.Xr relayd 8 ,
the default loopback binding is recommended.
.It Fl c Ar connections
Set the maximum number of concurrent connections.
The default is
.Cm 1280 .
Connections beyond this limit receive a 503 response and are closed
immediately.
.It Fl f Ar file
Load configuration from
.Ar file
instead of searching the default locations.
If the specified file does not exist or cannot be parsed,
.Nm
exits with an error.
See
.Sx CONFIGURATION FILE
for the file format and default search order.
.It Fl h
Print a usage summary and exit.
.It Fl p Ar port
Listen on the specified TCP port.
The default is
.Cm 9001 .
Ports below 1024 require root privileges.
.It Fl t Ar threads
Set the number of worker threads.
The default is
.Cm 4 .
Each worker independently dequeues and processes connections.
A value matching the CPU core count is a reasonable starting point.
The maximum is
.Cm 4
as compiled; recompile with a higher
.Dv THREAD_POOL_SIZE
to increase it.
.It Fl v
Enable verbose logging to standard error.
Logs include connection accept/close events, worker dispatch, and
security initialisation details.
.El
.Sh FEATURES
.Bl -bullet -compact
.It
Real-time system metrics: CPU load, memory, swap, disk usage,
network interfaces, and process summaries.
.It
Process monitoring with top 10 by CPU and top 10 by memory.
.It
Integrated manual page browser and search.
.It
Security hardening through
.Xr pledge 2
and
.Xr unveil 2 .
.It
High-performance architecture based on
.Xr kqueue 2
plus a worker thread pool.
.It
OpenBSD package manager interface: search packages, inspect metadata,
map file paths to owning packages, and list installed package files.
.It
RESTful JSON API for external integrations.
.It
No native TLS implementation by design; intended to run behind
.Xr relayd 8 .
.El
.Sh QUICK START
.Ss Prerequisites
.Bl -bullet -compact
.It
OpenBSD 7.8 or later.
.It
Base development tools:
.Xr clang 1
and
.Xr make 1 .
.It
Optional benchmark tooling:
.Xr wrk 1
and
.Xr gnuplot 1 .
.El
.Ss Build
.Bd -literal -offset indent
$ make clean && make
.Ed
.Ss Build man page
.Bd -literal -offset indent
$ make man
.Ed
.Ss Run unit tests
.Bd -literal -offset indent
$ make unit-tests
.Ed
.Ss Run
.Bd -literal -offset indent
$ ./build/miniweb -v
.Ed
Then open
.Lk http://127.0.0.1:9001 .
.Sh ENDPOINTS
.Nm
provides the following HTTP endpoints.
Responses follow HTTP/1.1 connection semantics: keep-alive is enabled by
default for HTTP/1.1 unless the client sends
.Cm Connection: close .
Handlers may also force close behavior, and each connection is capped at 64
served requests before being closed.
.Ss Route matching and response mechanism
Routing is evaluated in deterministic order:
.Bl -enum -compact
.It
exact static registrations loaded by
.Fn init_routes
.It
dynamic
.Pa /man/...
paths
.Pq GET only, with at least two slashes after the prefix
.It
dynamic
.Pa /api/man...
paths
.It
dynamic
.Pa /api/packages...
paths
.It
dynamic
.Pa /static/...
paths
.El
.Pp
Anything not matched returns an HTML 404 page generated by
.Fn http_send_error .
All routes are GET-only in the current implementation; non-GET requests
normally fall through to 404 rather than 405.
.Ss Web Interface
.Bl -tag -width Ds
.It Pa /
Main dashboard with system overview.
Tabbed navigation covers load averages, memory, disk, network interfaces,
and process information.
.It Pa /docs
Manual page browser with search powered by
.Xr apropos 1 .
.It Pa /networking
Network interface overview including routes and DNS configuration.
.It Pa /packages
Local package manager interface for searching package names, inspecting package
metadata, and mapping file paths to owning packages.
.It Pa /apiroot
API index page listing available endpoints and their response formats.
.El
.Ss Adding or Removing Regular Pages
Template-backed pages such as
.Pa /
and
.Pa /docs
are defined in a static table in
.Pa src/urls.c
.Pq Dv view_routes .
Each entry maps a method/path pair to:
.Bl -bullet -compact
.It
page title
.It
main content template
.Pq e.g. Pa dashboard.html
.It
optional extra head partial
.It
optional extra JavaScript partial
.El
.Pp
To add a page (for example
.Pa /about ):
.Bl -enum -compact
.It
Create templates in
.Pa templates/
for the main content and optional extras.
.It
Add a new entry to
.Dv view_routes
in
.Pa src/urls.c .
.It
Rebuild; startup route registration will include it automatically.
.El
.Pp
To remove a page, delete its corresponding
.Dv view_routes
entry and rebuild.
Requests to the removed path will then return 404.
.Ss Metrics API
.Bl -tag -width Ds
.It Pa /api/metrics
Returns a JSON object with the following fields:
.Bl -bullet -compact
.It
System information: hostname, OS version, uptime, architecture.
.It
CPU load averages: 1, 5, and 15 minute.
.It
Memory: total, free, active, wired, cached pages.
.It
Swap usage.
.It
Disk usage for all mounted filesystems.
.It
Network interface status and assigned addresses.
.It
Top 10 processes by CPU usage.
.It
Top 10 processes by memory usage.
.It
Process counts: total, running, sleeping, zombie.
.El
.Pp
Metrics are collected on request from native interfaces
without shelling out to external helper commands.
.It Pa /api/networking
Returns a JSON object with network interface details,
routing table entries, and DNS resolver configuration.
.El
.Ss Packages API
.Bl -tag -width Ds
.It Pa /api/packages/search?q={query}
Search installed packages by package name pattern via
.Xr pkg_info 1
.Cm -Q .
.It Pa /api/packages/info?name={package}
Return detailed information for one installed package via
.Xr pkg_info 1 .
.It Pa /api/packages/which?path={absolute_file_path}
Return package ownership for an absolute file path via
.Xr pkg_info 1
.Cm -E .
.It Pa /api/packages/files?name={package}
Return the file list installed by a package via
.Xr pkg_info 1
.Cm -L .
.It Pa /api/packages/list
Return all installed packages via
.Xr pkg_info -q .
.El
.Ss Manual Page API
.Bl -tag -width "/api/man/search"
.It Pa /api/man/search
Accepts a
.Cm ?q=
query parameter and returns raw
.Xr apropos 1
output, one entry per line.
Unlike other API endpoints, the response content type is
.Cm text/plain
to simplify line-based parsing in the frontend.
.It Pa /man/ Ns Ar area Ns / Ns Ar section Ns / Ns Ar page Ns Op Ar .ext
Renders a manual page via
.Xr mandoc 1 .
Supported extensions and their output formats:
.Pp
.Bl -tag -width ".html" -compact
.It Cm .html
HTML output
.Pq default if no extension is given .
.It Cm .md
Markdown.
.It Cm .pdf
PDF.
.It Cm .ps
PostScript.
.It Cm .txt
ASCII text.
.El
.Pp
Rendered man pages are cached for reuse under
.Pa static/man/ Ns Ar area Ns / Ns Ar section Ns / Ns Ar page Ns . Ns Ar ext
\(em equivalently
.Pa {static_dir}/man/...
using the configured static directory.
.El
.Ss Static Files
.Bl -tag -width Ds
.It Pa /static/ Ns Ar path
Serves static assets including CSS, JavaScript, and images.
The path component is validated to reject
.Sq ..
and
.Sq //
sequences.
Files are served from the
.Pa static/
directory relative to the working directory.
.It Pa /favicon.ico
Serves the site favicon from
.Pa static/assets/favicon.svg
as
.Cm image/svg+xml .
.El

.Ss Caching facilities
MiniWeb currently implements three cache layers:
.Bl -enum
.It
Template cache in
.Pa src/template_engine.c :
all files under
.Pa templates_dir
are read at startup and retained in memory for subsequent renders.
There is no runtime invalidation; restart to refresh templates.
.It
In-memory static payload cache in
.Pa src/http_handler.c :
.Bl -bullet -compact
.It
32 slots
.Pq Dv FILE_CACHE_SLOTS .
.It
Maximum payload size 256 KiB per cached object
.Pq Dv FILE_CACHE_MAX_BYTES .
.It
Two-hit admission via candidate table before insertion.
.It
Insertion token budget of 8 inserts per second
.Pq Dv FILE_CACHE_INSERTS_PER_SEC .
.It
Age-based eviction for entries and candidates after 120 seconds
.Pq Dv FILE_CACHE_MAX_AGE_SEC .
.It
Validation key is
.Pq path, mtime ;
mtime mismatch forces miss.
.El
.It
On-disk man render cache in
.Pa src/man.c :
rendered outputs for
.Cm html ,
.Cm txt ,
.Cm md ,
.Cm ps
and
.Cm pdf
are stored under
.Pa {static_dir}/man/{area}/{section}/{page}.{format}
and served through the static-file path on cache hits.
Those files may then also be promoted into the in-memory static cache.
.El

.Sh ARCHITECTURE
.Ss Request lifecycle
.Bd -literal -offset indent
accept()
   |
   v
kqueue dispatcher (main thread)
   |  EV_DISPATCH -> event auto-disabled after delivery
   v
work queue (pthread_cond_wait, zero busy-waiting)
   |
   v
worker thread (1 of N)
   |  recv() -> parse -> route_match() -> handler()
   v
close(fd) + free_connection()
.Ed
.Pp
The main thread performs accept and queueing only.
Workers do not call
.Xr kevent 2 ,
which avoids worker-side races.
Use of
.Dv EV_DISPATCH
ensures one delivery per readiness event, preventing two workers from
processing the same connection concurrently.
Internal refactoring consolidates connection teardown through a single helper and centralises view-template response rendering through a shared HTTP helper, reducing duplicated handler logic.
.Ss Key components
.Bl -tag -width Ds
.It Pa src/main.c
Single
.Xr kqueue 2
owned by the dispatcher thread, connection pool indexed by file
descriptor, generation counters for stale descriptor detection, and
periodic idle timeout sweeps.
.It Pa src/urls.c
Declarative routing tables for template-backed views and grouped API
route registration helpers.
.It Pa src/http_handler.c
Thread-safe per-request scratch buffers for header extraction and
effective client IP computation with precedence:
X-Real-IP, then X-Forwarded-For (first value), then peer socket address;
includes a shared template render/send helper used by view handlers.
.It Pa src/metrics.c
System metrics through native interfaces only:
.Xr sysctl 2 ,
.Xr getloadavg 3 ,
.Xr getmntinfo 3 ,
.Xr getifaddrs 3 ;
includes a retry loop around
.Dv KERN_PROC_ALL
snapshot sizing.
.It Pa src/template_engine.c
Minimal
.Cm {{TOKEN}}
substitution-based rendering from files under
.Pa templates/ .
.El
.Ss kqueue and memory-path analysis
Current behavior is optimized for concurrent request handling using a
single dispatcher thread and
.Dv EV_DISPATCH
for one-shot readiness delivery.
The work queue is already implemented as a circular buffer
.Pq head/tail/count over fixed capacity .
.Pp
Latest merged implementation work
.Pq PR-41
focused on efficiency rather than headline throughput: connection and
response object pooling, plus static cache admission/rate/age controls.
This keeps requests/s close to previous runs while reducing allocator and
CPU pressure under sustained concurrency.
.Pp
Strategic performance points:
.Bl -bullet -compact
.It
Batching multiple
.Xr kevent 2
change operations can reduce syscall overhead in high fan-in bursts.
.It
Queue saturation and keep-alive rearm failures should be exported as
metrics to tune thread and queue caps from real traffic.
.It
A per-connection circular RX buffer may reduce allocator/cache pressure
for highly fragmented header arrivals.
.It
The TX path already uses
.Xr writev 2 ;
a separate TX ring buffer is usually unnecessary unless protocol
pipelining or async multi-response buffering is introduced.
.El
.Pp
Memory allocation hotspots:
.Bl -bullet -compact
.It
Connection objects now come from a preallocated slab and are returned to
a free-stack on close/timeout (no hot-path per-accept heap allocation).
.It
Static file cache replacement performs
.Xr malloc 3 /
.Xr free 3
for cached payload copies.
.It
.Vt http_response_t
objects now come from a fixed pool (256 entries) guarded by a mutex.
.El
.Sh PERFORMANCE
Measured on OpenBSD 7.8 (amd64, 4-core CPU) with
.Xr wrk 1
.Pq 4 worker threads, 20 s per run .
Connection counts in parentheses indicate the concurrency level at which
each figure was recorded.
.Ss Static file serving
.Bl -tag -width "/static/assets/favicon.svg (32 conns)"
.It Pa /static/test.html Pq 32 connections
23,201 requests/s; avg latency 1.47 ms.
.It Pa /static/css/custom.css Pq 32 connections
18,335 requests/s; avg latency 1.62 ms.
.It Pa /static/js/theme_toggler.js Pq 32 connections
17,965 requests/s; avg latency 1.68 ms.
.It Pa /static/assets/favicon.svg Pq 32 connections
17,557 requests/s; avg latency 1.72 ms.
.El
.Pp
Static file throughput peaks above 23,000 requests/s at moderate concurrency.
All four endpoints sustain over 17,000 requests/s at 32 concurrent connections
with sub-2 ms average latency.
.Ss Dynamic page rendering
.Bl -tag -width "/networking (32 conns)"
.It Pa /docs Pq 32 connections
9,615 requests/s; avg latency 3.46 ms.
.It Pa / Pq 64 connections
7,851 requests/s; avg latency 8.89 ms.
.It Pa /networking Pq 32 connections
2,030 requests/s; avg latency 19.34 ms.
.It Pa /packages Pq 32 connections
6,109 requests/s; avg latency 5.36 ms.
.It Pa /apiroot Pq 32 connections
5,324 requests/s; avg latency 6.03 ms.
.El
.Pp
Template-backed pages sustain 5,000\(en9,600 requests/s.
The
.Pa /networking
endpoint is slower because it collects live interface, routing,
and DNS data on every request.
.Ss JSON API endpoints
.Bl -tag -width "/api/networking (64 conns)"
.It Pa /api/networking Pq 64 connections
1,790 requests/s; avg latency 35.53 ms.
.It Pa /api/metrics Pq 64 connections
101 requests/s; avg latency 604.94 ms.
.El
.Pp
.Pa /api/metrics
throughput is bounded by the cost of a full system snapshot
.Pq sysctl, process table, filesystem and network enumeration
collected on every request, not by the HTTP layer.
.Ss Package API endpoints
.Bl -tag -width "/api/packages/search (8 conns)"
.It Pa /api/packages/search Pq 8 connections
11 requests/s; avg latency 686 ms.
.It Pa /api/packages/info Pq 8 connections
14 requests/s; avg latency 556 ms.
.It Pa /api/packages/files Pq 8 connections
9 requests/s; avg latency 823 ms.
.El
.Pp
Package API throughput is bounded entirely by
.Xr pkg_info 1
subprocess execution time.
These endpoints spawn an external process per request and are not
intended for high-frequency automated polling.
.Ss Manual page endpoints
.Bl -tag -width "/api/man/search (32 conns)"
.It Pa /api/man/search Pq 32 connections
22 requests/s uncached; avg latency 1,370 ms.
Cached responses are served directly from disk and drop to
single-digit millisecond latency.
.It Pa /man/1/1/ls Pq 32 connections
4 requests/s uncached.
After the first render the page is cached under
.Pa static/man/
and subsequent requests are served at static-file speeds.
.El
.Pp
First-render latency for manual page endpoints is dominated by
.Xr mandoc 1
subprocess time.
.Ss Hard-coded caps and effective ranges
Some limits are compile-time hard caps and override broader config parser
ranges.
.Pp
.Bl -tag -width "REQUEST_BUFFER_SIZE"
.It Dv MAX_EVENTS
64 events per
.Xr kevent 2
wait cycle.
.It Dv MAX_CONNECTIONS
1280 active connections maximum.
.It Dv THREAD_POOL_SIZE
4 worker threads maximum.
.It Dv REQUEST_BUFFER_SIZE
16384 bytes receive buffer hard cap for request headers.
.It Dv LISTEN_BACKLOG
128 pending connection backlog hint.
.It Dv QUEUE_CAPACITY
512 dispatched connections queued before overload drop.
.It Dv MAX_KEEPALIVE_REQUESTS
64 requests per keep-alive connection before forced close.
.It Dv WRITE_RETRY_LIMIT
256 write retry cycles on
.Dv EAGAIN .
.It Dv WRITE_WAIT_MS
100 ms poll wait per write retry cycle.
.It Dv FILE_CACHE_SLOTS
32 in-memory static file cache entries.
.It Dv FILE_CACHE_MAX_BYTES
256 KiB maximum size per cached file.
.It Dv FILE_CACHE_INSERTS_PER_SEC
8 cache insertions per second (token budget).
.It Dv FILE_CACHE_MAX_AGE_SEC
120 seconds max age before cache/candidate eviction.
.It Dv RESPONSE_POOL_ITEMS
256 reusable HTTP response objects in the internal pool.
.El
.Pp
Effective runtime ranges for user-configurable caps:
.Bl -tag -width "max_req_size"
.It Cm threads
Parser: 1\(en64; effective runtime: 1\(en4
.Pq clamped by Dv THREAD_POOL_SIZE .
.It Cm max_conns
Parser: 1\(en65535; effective runtime: 1\(en1280
.Pq clamped by Dv MAX_CONNECTIONS .
.It Cm max_req_size
Parser: 1024\(en1048576; effective runtime: 1024\(en16384
.Pq clamped by Dv REQUEST_BUFFER_SIZE .
.It Cm conn_timeout
1\(en3600 seconds effective.
.It Cm mandoc_timeout
1\(en120 seconds effective.
.It Cm port
1\(en65535 effective.
.El

.Sh SECURITY
.Ss Sandboxing
.Nm
limits filesystem and execution access with
.Xr unveil 2
to:
.Bd -literal -offset indent
templates/          r
static/             rwc
/usr/share/man      r
/usr/local/man      r
/usr/X11R6/man      r
/usr/bin/mandoc     x
/usr/bin/man        x
/usr/bin/apropos    x
/bin/ps             x
/usr/bin/netstat    x
/bin/sh             x
/etc/man.conf       r
/dev/null           rw
/usr/sbin/pkg_info  x
/var/db/pkg         r
/usr/local          r
/usr/bin            r
/usr/sbin           r
/bin                r
/sbin               r
/usr/local/bin      r
/etc/passwd         r
/etc/group          r
/etc/resolv.conf    r
.Ed
.Pp
Current
.Xr pledge 2
promises:
.Bd -literal -offset indent
stdio rpath wpath cpath inet route proc exec vminfo ps getpw
.Ed
.Ss Additional mitigations
.Bl -bullet -compact
.It
Static path traversal protection: requests containing
.Sq ..
or
.Sq //
are rejected.
.It
Connection limiter: excess accepted clients are answered with HTTP 503
and immediately closed.
.It
Input sanitisation for manual page parameters before invoking
.Xr mandoc 1 .
.It
Reverse-proxy headers are trusted only from
.Cm trusted_proxy .
.El
.Ss Known limitations
.Bl -bullet -compact
.It
No built-in TLS.
.It
No authentication layer.
.It
Some JSON fields can be truncated by fixed-size buffers under extreme
input sizes.
.It
Timeout logic cannot preempt a kernel-level stall inside
.Xr mandoc 1 .
.El
.Sh REVERSE PROXY
.Nm
is designed to run behind
.Xr relayd 8 .
When a reverse proxy is present,
.Nm
reads the following request headers to determine the real client
address and original protocol:
.Bl -tag -width "X-Forwarded-Proto" -compact
.It Cm X-Real-IP
Preferred header for the client IP address.
.It Cm X-Forwarded-For
Used if
.Cm X-Real-IP
is absent; the first comma-separated value is taken.
.It Cm X-Forwarded-Proto
Set to
.Cm https
by
.Xr relayd 8
to indicate that the original connection used TLS.
.El
.Pp
If none of these headers are present, the peer address of the TCP
connection is used.
.Pp
These headers should be set exclusively by the reverse proxy and must
not be accepted from untrusted clients.
Configure
.Xr relayd 8
to overwrite rather than append them.
.Sh CONFIGURATION FILE
.Nm
reads a configuration file at startup before applying command-line flags.
The file is searched in the following order; the first match is used:
.Bl -enum -compact
.It
Path supplied with
.Fl f Ar file
.Pq explicit, failure is fatal .
.It
.Pa ./miniweb.conf
.Pq current working directory .
.It
.Pa $HOME/.miniweb.conf
.It
.Pa /etc/miniweb.conf
.El
.Pp
If no file is found, compiled-in defaults are used.
Command-line flags always take precedence over file values.
.Pp
The file format is one directive per line:
.Bd -literal -offset indent
key    value
.Ed
.Pp
Lines beginning with
.Sq #
are comments.
Blank lines are ignored.
Keys are case-insensitive.
.Pp
Recognised directives:
.Bl -tag -width "mandoc_timeout"
.It Cm port Ar n
TCP port to listen on.
Range 1\(en65535.
Default:
.Cm 9001 .
.It Cm bind Ar address
IPv4 address to bind to.
Default:
.Cm 127.0.0.1 .
.It Cm threads Ar n
Number of worker threads.
Range 1\(en64 in parser; effective runtime range 1\(en4
.Pq hard-capped by Dv THREAD_POOL_SIZE .
Default:
.Cm 4 .
.It Cm max_conns Ar n
Maximum concurrent connections.
Range 1\(en65535 in parser; effective runtime range 1\(en1280
.Pq hard-capped by Dv MAX_CONNECTIONS .
Default:
.Cm 1280 .
.It Cm conn_timeout Ar seconds
Idle connection timeout.
Range 1\(en3600.
Default:
.Cm 30 .
.It Cm max_req_size Ar bytes
Maximum HTTP request size in bytes.
Range 1024\(en1048576 in parser; effective runtime range 1024\(en16384
.Pq hard-capped by Dv REQUEST_BUFFER_SIZE .
Default:
.Cm 16384 .
.It Cm mandoc_timeout Ar seconds
Timeout for
.Xr mandoc 1
subprocess invocations.
Range 1\(en120.
Default:
.Cm 10 .
.It Cm static_dir Ar path
Directory from which static assets are served.
Default:
.Cm static .
.It Cm templates_dir Ar path
Directory containing HTML templates.
Default:
.Cm templates .
.It Cm mandoc_path Ar path
Absolute path to the
.Xr mandoc 1
binary.
Default:
.Cm /usr/bin/mandoc .
.It Cm trusted_proxy Ar address
IPv4 address of the reverse proxy from which
.Cm X-Forwarded-For ,
.Cm X-Forwarded-Proto ,
and
.Cm X-Real-IP
headers are accepted.
Default:
.Cm 127.0.0.1 .
.It Cm verbose Ar bool
Enable verbose logging.
Accepted values:
.Cm yes ,
.Cm no ,
.Cm true ,
.Cm false ,
.Cm 1 ,
.Cm 0 .
Default:
.Cm no .
.El
.Pp
Unknown directives produce a warning on standard error but do not abort startup.
.Sh FILES
.Bl -tag -width "templates/" -compact
.It Pa ./miniweb.conf
.It Pa $HOME/.miniweb.conf
.It Pa /etc/miniweb.conf
Configuration files searched in order at startup.
See
.Sx CONFIGURATION FILE .
.It Pa templates/
HTML templates for dashboard and documentation pages.
Must be unveiled read-only.
.It Pa static/
Static assets served under
.Pa /static/ .
Must be unveiled read-only.
.It Pa /etc/passwd
Consulted for user name lookups in process listings.
Unveiled for
.Xr getpwuid 3 .
.It Pa /etc/group
Consulted for group name lookups.
Unveiled read-only.
.It Pa /etc/resolv.conf
Read for DNS resolver configuration displayed on the networking page.
Unveiled read-only.
.It Pa /etc/man.conf
Read by
.Xr mandoc 1
at startup.
.It Pa /usr/share/man
.It Pa /usr/local/man
.It Pa /usr/X11R6/man
Manual page directories.
All three are unveiled read-only.
.It Pa /usr/bin/mandoc
Manual page formatter.
Unveiled for execution.
.It Pa /usr/bin/apropos
Used for manual page search.
Unveiled for execution.
.It Pa /bin/ps
.It Pa /usr/bin/netstat
.It Pa /bin/sh
Unveiled for execution by metric and networking collectors.
.It Pa /usr/sbin/pkg_info
Package information tool.
Unveiled for execution by the packages API.
.It Pa /var/db/pkg
Installed package database.
Unveiled read-only for
.Xr pkg_info 1 .
.It Pa /usr/local
.It Pa /usr/bin
.It Pa /usr/sbin
.It Pa /bin
.It Pa /sbin
Unveiled read-only so that
.Xr pkg_info 1
.Fl E
can stat arbitrary file paths across the standard directory trees.
.El
.Sh EXAMPLES
Start the server on the default port with verbose logging:
.Bd -literal -offset indent
$ miniweb -v
.Ed
.Pp
Load an explicit configuration file:
.Bd -literal -offset indent
$ miniweb -f /etc/miniweb.conf
.Ed
.Pp
Override a single value from the config file on the command line:
.Bd -literal -offset indent
$ miniweb -f /etc/miniweb.conf -p 8080
.Ed
.Pp
Listen on all interfaces on port 8080 with 8 worker threads:
.Bd -literal -offset indent
$ miniweb -b 0.0.0.0 -p 8080 -t 8
.Ed
.Pp
Production configuration behind a reverse proxy,
high connection limit:
.Bd -literal -offset indent
$ miniweb -b 127.0.0.1 -p 9001 -c 1280 -t 4
.Ed
.Pp
Query the metrics endpoint directly:
.Bd -literal -offset indent
$ curl -s http://127.0.0.1:9001/api/metrics | jq .
.Ed
.Pp
Minimal
.Xr relayd 8
configuration for TLS termination.
.Xr acme-client 1
or
.Xr acme-client.conf 5
should be used to provision the certificate beforehand:
.Bd -literal -offset indent
table <miniweb> { 127.0.0.1 }

http protocol "https_proxy" {
    tls keypair "server"

    match request header set "X-Forwarded-For" \e
        value "$REMOTE_ADDR"
    match request header set "X-Forwarded-Proto" \e
        value "https"
    match request header set "X-Real-IP" \e
        value "$REMOTE_ADDR"
    match request header set "Host" \e
        value "$HOST"

    tcp { nodelay }
}

relay "https_frontend" {
    listen on egress port 443 tls
    protocol "https_proxy"
    forward to <miniweb> port 9001
}

relay "http_redirect" {
    listen on egress port 80
    forward to <miniweb> port 9001
}
.Ed
.Pp
Verify that all endpoints respond correctly through the proxy:
.Bd -literal -offset indent
$ for p in / /docs /apiroot /networking /packages \e
      /api/metrics /api/networking \e
      '/api/packages/search?q=curl' \e
      '/api/man/search?q=pledge' \e
      /static/css/custom.css /favicon.ico; do
    printf '%-44s %s\en' "$p" \e
      "$(curl -sk -o /dev/null \e
         -w '%{http_code}' "https://example.com$p")"
  done
.Ed
.Pp
Esempio di script
.Xr rc.d 8
per eseguire
.Nm
come servizio su OpenBSD:
.Bd -literal -offset indent
# cat /etc/rc.d/miniweb
#!/bin/ksh

daemon="/home/flavio/DEV/miniweb/build/miniweb"
daemon_flags="-f /etc/miniweb.conf"
daemon_user="flavio"

. /etc/rc.d/rc.subr

rc_bg=YES
rc_cmd $1
.Ed
.Sh DEVELOPMENT
.Ss Testing
.Bd -literal -offset indent
$ make unit-tests

$ for p in / /docs /apiroot /networking \
      /api/metrics /api/networking \
      /static/css/custom.css /favicon.ico; do
    printf '%-30s %s\n' "$p" \
      "$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:9001$p)"
  done

$ curl -s 'http://127.0.0.1:9001/api/man/search?q=pledge'
$ curl -s http://127.0.0.1:9001/api/metrics | jq .
.Ed
.Ss Debug build
.Bd -literal -offset indent
$ make DEBUG=1
$ ./build/miniweb -v
.Ed
.Sh TROUBLESHOOTING
.Bl -tag -width "[write_all] Too many EAGAIN retries" -compact
.It Cm bind: Address already in use
Another process already owns the selected listening port.
.It Cm pledge: Operation not permitted
Runtime attempted a syscall not included in the current promise set.
.It Cm sysctl data query failed: Cannot allocate memory
Process table changed during snapshot collection; retry logic handles
temporary races.
.It Cm [write_all] Too many EAGAIN retries
Client socket remained back-pressured for too long; connection is dropped.
.It Cm Man pages not rendering
Verify
.Xr mandoc 1
availability and unveil permissions; run with
.Fl v
for detail.
.El
.Sh ROADMAP
.Bl -bullet
.It
Add explicit 405 handling for non-GET requests on known endpoints,
including
.Cm Allow
response headers.
.It
Add conditional HTTP cache validators
.Pq ETag/If-None-Match and Last-Modified/If-Modified-Since
for static and man-cache responses.
.It
Expose cache observability metrics (hit/miss/admission/eviction)
for static and man caches via
.Pa /api/metrics .
.It
Add live metrics streaming (SSE or WebSocket) to reduce polling overhead.
.It
Add IPv6 listener support and dual-stack configuration.
.It
Add Prometheus exporter endpoint.
.It
Evaluate portability work for FreeBSD/NetBSD-specific metrics and route collection.
.El
.Sh LICENSE
BSD 3-Clause License.
.Sh Third-Party Assets
This project includes the
.Cm Satoshi
font family, designed by
.Cm Indian Type Foundry
(https://www.fontshare.com/fonts/satoshi).
.Bl -bullet -compact
.It
Font License: The font is included under the
.Cm Fontshare Personal & Commercial Use License
(https://www.fontshare.com/terms).
.It
The font remains the property of its respective owners and
.Cm is not
covered by this project's BSD 3-Clause License.
.Sh ACKNOWLEDGMENTS
Built on OpenBSD interfaces and security model, in particular
.Xr kqueue 2 ,
.Xr pledge 2 ,
.Xr unveil 2 ,
and
.Xr sysctl 2 .
.Sh DIAGNOSTICS
.Ex -std
.Pp
The following messages may appear on standard error:
.Bl -tag -width Ds
.It Dq bind: Address already in use
Another process is listening on the specified port.
Use
.Ql fstat | grep Ar :port
to identify it.
.It Dq pledge: Operation not permitted
A system call was attempted outside the current
.Xr pledge 2
promise set.
The required promises are:
.Cm stdio rpath wpath cpath inet route proc exec vminfo ps getpw .
.It Dq sysctl data query failed: Cannot allocate memory
The process table is growing faster than the buffer can be resized.
.Nm
retries automatically; if the condition persists, investigate runaway
process creation.
.It Dq [write_all] Too many EAGAIN retries
The client socket buffer remained full for too many polling cycles.
The connection is dropped.
This may indicate a very slow or unresponsive client.
.It Dq Connection limit reached, rejected fd= Ns Ar n
The active connection count reached the value set by
.Fl c .
Increase the limit or reduce connection hold time.
.El
.Sh SEE ALSO
.Xr acme-client 1 ,
.Xr apropos 1 ,
.Xr curl 1 ,
.Xr mandoc 1 ,
.Xr kqueue 2 ,
.Xr pledge 2 ,
.Xr sysctl 2 ,
.Xr unveil 2 ,
.Xr getifaddrs 3 ,
.Xr getloadavg 3 ,
.Xr getmntinfo 3 ,
.Xr getpwuid 3 ,
.Xr relayd 8
.Sh STANDARDS
The HTTP implementation follows RFC 7230 through RFC 7235
.Pq HTTP/1.1 .
Persistent connections
.Pq keep-alive
are supported for sequential requests
.Pq no pipelining ,
with an internal per-connection cap of 64 requests.
.Sh HISTORY
.Nm
was originally based on
.Nm libmicrohttpd .
In early 2026 it was rewritten to use a native
.Xr kqueue 2
dispatcher with a
.Dv EV_DISPATCH Ns -based
worker pool, removing the external library dependency and improving
throughput from roughly 7,000 requests per second to over 23,000
requests per second on static-file benchmarks on a four-core system
(approximately +228%, measured with
.Xr wrk 1
at 32 concurrent connections).
A configuration file facility was added shortly after,
replacing all hardcoded values with a runtime-configurable
.Pa miniweb.conf
read by
.Pa src/conf.c .
Later iterations added pooled response objects, bounded/admission-controlled
in-memory static file caching, and on-disk rendered manpage reuse under
.Pa static/man/...
for repeat requests.
.Sh AUTHORS
.An Flavio Ferretti flavio@flvbox.org
.Sh CAVEATS
.Nm
is OpenBSD-specific.
It depends on
.Xr kqueue 2 ,
.Xr pledge 2 ,
.Xr unveil 2 ,
and OpenBSD
.Xr sysctl 2
MIBs.
Porting to other systems requires substantial changes.
.Pp
The manual page renderer invokes
.Xr mandoc 1
as a subprocess.
Although isolated by
.Xr pledge 2
and
.Xr unveil 2 ,
the subprocess execution path represents additional attack surface.
User-supplied section, area, and page name components are sanitised
before use; only alphanumeric characters, hyphens, underscores,
periods, and plus signs are permitted.
.Pp
JSON output uses fixed-size buffers.
Extremely long hostnames, mount point paths, or process argument
lists may be silently truncated.
.Sh SECURITY CONSIDERATIONS
.Nm
implements layered security using native OpenBSD facilities:
.Bl -bullet
.It
.Xr pledge 2
restricts available system calls to those required for normal operation.
.It
.Xr unveil 2
limits filesystem access to
.Pa templates/ ,
.Pa static/ ,
the system manual page directories, and a small set of executable paths.
.It
Path traversal is rejected in the static file handler by refusing any
path containing
.Sq ..
or
.Sq //
sequences.
.It
The connection pool limits active connections and allocates each on the
heap; a connection exceeding the pool size receives a 503 response and
is closed without further processing.
.It
.Cm X-Forwarded-For
and related headers are set by
.Xr relayd 8
and must not be trusted from direct external connections.
Deploy with
.Fl b Cm 127.0.0.1
and route all external traffic through the reverse proxy.
.El
.Pp
Never expose
.Nm
directly to untrusted networks.
.Sh BUGS
Subprocess timeout handling for
.Xr mandoc 1
invocations relies on
.Xr poll 2
with a wall-clock deadline.
A kernel stall inside
.Xr mandoc 1
itself cannot be interrupted by this mechanism.
.Pp
The template engine performs token substitution without HTML escaping.
Currently all values passed to templates are trusted strings written
directly in the source code, so no user input reaches the substitution
step and there is no immediate risk.
If future changes introduce user-supplied input into template rendering
.Pq for example, echoing a search query into a page title ,
a proper escaping pass must be added to prevent cross-site scripting.
.Pp
Only IPv4 is supported.
IPv6 requires changes to the socket creation and address handling code.
