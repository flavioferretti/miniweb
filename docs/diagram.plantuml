@startuml
skinparam handwritten false
skinparam monochrome false
skinparam shadowing false
left to right direction

skinparam package {
  BorderColor #2d3436
}

skinparam component {
  BackgroundColor #F7FBFF
  BorderColor #2D3436
  FontColor #1F2933
}

' =========================
' AREA 1: PROJECT FUNCTIONS
' =========================
package "<&layers*1> Project functions" #EAF4FF {
  component "main.c\n(queue_*, worker_thread,\nconnection slab/free-stack, main)" as Main #A8D8FF
  component "http_handler.c\n(http_response_* pool,\nhttp_send_file with memory cache,\nhttp_send_error/http_render_template)" as HTTP #9ED9FF
  component "urls.c\n(init_routes, route_match,\nregister_route, find_view_route)" as URLS #B8E0FF
  component "routes.c\n(view/static/favicon handlers,\nrender_template_response)" as Routes #C4E8FF
  component "metrics.c\n(get_system_metrics_json, metrics_*)" as Metrics #D6EFFF
  component "networking.c\n(networking_get_*, networking_*_handler)" as Net #CFE6FF
  component "man.c\n(man_api_handler, man_render_handler,\non-disk man cache)" as Man #E3F2FF
  component "pkg_manager.c\n(pkg_*_json, pkg_api_handler)" as Pkg #D9F7FF
  component "template_engine.c\n(template cache preload +\ntemplate_render*)" as Template #FFF2B2
  component "http_utils.c\n(json_escape_string, safe_popen_read*)" as Utils #FFE6B2
  component "conf.c\n(conf_defaults/load/dump)" as Conf #DFF7E2
}

' =============================
' AREA 2: STD C / POSIX LIBRARY
' =============================
package "<&book*1> Std C / POSIX library" #FFF7E6 {
  component "stdio.h\n(fopen/fclose/fread/fgets,\nprintf/fprintf/snprintf, sscanf)" as LibStdio #FFE1B3
  component "stdlib.h + string.h\n(malloc/calloc/free, getenv,\nstr* family, qsort)" as LibStd #FFE8C9
  component "pthread.h\n(pthread_*, cond/mutex ops)" as LibPthread #FFD8A8
  component "network libc\n(inet_pton/ntop, htons, getifaddrs,\nif_indextoname, gethostname)" as LibNet #FFEED8
  component "filesystem/dir libc\n(open/read/write, opendir/readdir,\nfstat, getmntinfo)" as LibFs #FFE4C4
  component "process/time libc\n(getopt, time/localtime_r,\ngetpwuid_r, difftime, getloadavg)" as LibProc #FFEBCF
}

' ==============
' AREA 3: KERNEL
' ==============
package "<&cloud*1> Kernel / system calls" #FFE9EC {
  component "kqueue/kevent" as Kevent #FFC6CF
  component "socket/accept/bind/listen" as Ksock #FFB8C6
  component "read/write/open/close/fcntl" as Kio #FFC9D4
  component "sysctl/swapctl/uname" as Ksys #FFD6DE
  component "signal/pledge/unveil" as Ksec #FFCCD6
}

' -------------------------
' Project -> Project calls
' -------------------------
Main --> HTTP : http_send_error(), http_request_*\n(http_handler.h)
Main --> URLS : init_routes(), route_match()\n(urls.h)
Main --> Conf : conf_defaults/load/dump(), conf_apply_cli()\n(conf.h)

URLS --> Routes : view_template_handler(), favicon_handler(),\nstatic_handler()\n(routes.h)
URLS --> Metrics : metrics_handler()\n(metrics.h)
URLS --> Net : networking_api_handler()\n(networking.h)
URLS --> Man : man_api_handler(), man_render_handler()\n(man.h)
URLS --> Pkg : pkg_api_handler()\n(pkg_manager.h)

Routes --> Template : template_render(), template_render_with_data()\n(template_engine.h)
Routes --> HTTP : http_response_*, http_send_*\n(http_handler.h)

Metrics --> HTTP : http_response_*, http_send_error()\n(http_handler.h)
Metrics --> Utils : json_escape_string()\n(http_utils.h)

Net --> HTTP : http_response_*, http_send_error(),\nhttp_render_template()\n(http_handler.h)

Man --> HTTP : http_response_*, http_send_error()\n(http_handler.h)
Man --> Utils : safe_popen_read_argv()\n(http_utils.h)

Pkg --> HTTP : http_response_*, http_send_json(),\nhttp_send_error()\n(http_handler.h)
Pkg --> Utils : safe_popen_read_argv(),\njson_escape_string()\n(http_utils.h)

Template --> Template : read_file_content(), read_template_file(),\nreplace_single(), replace_all()
HTTP --> HTTP : write_all(), writev_all(),\nhttp_request_get_header()

' -----------------------------------
' Project -> Std C / POSIX lib calls
' -----------------------------------
Conf --> LibStdio : fopen/fgets/fclose/fprintf/snprintf\n(<stdio.h>)
Conf --> LibStd : memset/strtol/strcasecmp/strcmp/strlen/strlcpy\n(<string.h>, <stdlib.h>, <strings.h>)
Conf --> LibProc : getenv/getpwuid/getuid\n(<stdlib.h>, <pwd.h>, <unistd.h>)

Main --> LibPthread : pthread_create/join, mutex/cond ops\n(<pthread.h>)
Main --> LibNet : inet_pton/ntop, htons\n(<arpa/inet.h>)
Main --> LibFs : recv/write/close/fcntl\n(<sys/socket.h>, <unistd.h>, <fcntl.h>)
Main --> LibProc : time/getopt/atoi/signal\n(<time.h>, <unistd.h>, <stdlib.h>, <signal.h>)
Main --> LibStd : calloc/free/memcpy/memset/str*\n(<stdlib.h>, <string.h>)

HTTP --> LibStdio : snprintf\n(<stdio.h>)
HTTP --> LibStd : calloc/malloc/free/memcpy/strlen/strchr/strstr\n(<stdlib.h>, <string.h>)
HTTP --> LibNet : inet_ntop\n(<arpa/inet.h>)
HTTP --> LibFs : open/read/write/writev/close/fstat\n(<fcntl.h>, <unistd.h>, <sys/uio.h>, <sys/stat.h>)

Template --> LibStdio : fopen/fseek/ftell/fread/fclose/snprintf\n(<stdio.h>)
Template --> LibStd : malloc/free/memcpy/strlen/strstr/strdup\n(<stdlib.h>, <string.h>)

Metrics --> LibProc : time/localtime_r/strftime/getloadavg/difftime\n(<time.h>, <stdlib.h>)
Metrics --> LibNet : getifaddrs/freeifaddrs/inet_ntop/gethostname\n(<ifaddrs.h>, <arpa/inet.h>, <unistd.h>)
Metrics --> LibStd : malloc/calloc/free/qsort/snprintf/str*\n(<stdlib.h>, <string.h>, <stdio.h>)

Net --> LibStdio : fopen/fgets/fclose/snprintf\n(<stdio.h>)
Net --> LibNet : if_indextoname/inet_ntop/getifaddrs/freeifaddrs\n(<net/if.h>, <arpa/inet.h>, <ifaddrs.h>)
Net --> LibStd : malloc/free/memset/str*\n(<stdlib.h>, <string.h>)

Man --> LibStd : malloc/free/strdup/strlen/str*\n(<stdlib.h>, <string.h>)
Man --> LibFs : opendir/readdir/closedir\n(<dirent.h>)
Pkg --> LibStd : malloc/free/strtol/strtok_r/str*\n(<stdlib.h>, <string.h>)

Routes --> LibStd : snprintf/strncmp/strstr/strlen\n(<stdio.h>, <string.h>)
URLS --> LibStd : strcmp/strncmp\n(<string.h>)
Utils --> LibStd : malloc/strdup/strlen/isalnum\n(<stdlib.h>, <string.h>, <ctype.h>)

note right of Main
  Hard caps (compiled):
  MAX_CONNECTIONS=1280
  THREAD_POOL_SIZE=4
  REQUEST_BUFFER_SIZE=16384
  QUEUE_CAPACITY=512
  MAX_KEEPALIVE_REQUESTS=64
end note

note right of HTTP
  In-memory static cache:
  - 32 slots, 256KiB/object max
  - 2-hit admission candidate table
  - insertion token budget: 8/sec
  - age eviction: 120s entries/candidates
  Response pool: 256 objects
end note

note bottom of URLS
  Route resolution order:
  1) exact registered routes
  2) /man/... (GET)
  3) /api/man...
  4) /api/packages...
  5) /static/...
end note

note right of Man
  Persistent render cache path:
  {static_dir}/man/{area}/{section}/{page}.{fmt}
  Cached formats: html/txt/md/ps/pdf
end note

note right of Template
  templates_dir files are preloaded
  at startup by template_cache_init()
end note

' ----------------------
' System call tracking
' ----------------------
Main --> Kevent : kqueue(), kevent()\n(<sys/event.h>)
Main --> Ksock : socket(), bind(), listen(), accept(), setsockopt()\n(<sys/socket.h>)
Main --> Kio : recv(), write(), close(), fcntl()\n(<sys/socket.h>, <unistd.h>, <fcntl.h>)
Main --> Ksec : signal(), pledge(), unveil()\n(<signal.h>, <unistd.h>)

HTTP --> Kio : open(), read(), write(), writev(), close()\n(<fcntl.h>, <unistd.h>, <sys/uio.h>)
Metrics --> Ksys : sysctl(), swapctl(), uname()\n(<sys/sysctl.h>, <sys/swap.h>, <sys/utsname.h>)
Net --> Ksys : sysctl()\n(<sys/sysctl.h>)

' libc wrappers to kernel (conceptual)
LibPthread --> Kio : futex/sched primitives (platform dependent)
LibFs --> Kio : file descriptor syscalls
LibNet --> Ksock : socket stack syscalls
LibProc --> Ksys : time/proc/sysctl wrappers

@enduml
