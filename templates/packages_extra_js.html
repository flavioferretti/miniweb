<script>
(() => {
  const tabs = document.getElementById('pkgTabNavigation');
  const dashboard = document.getElementById('packages-dashboard');
  if (!tabs || !dashboard) return;

  let currentTab = 'search';

  const esc = (value) => String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;');

  const panel = (title, body) => `
    <article class="panel stat-card">
      <h3>${title}</h3>
      ${body}
    </article>
  `;

  const searchView = () => panel('Search packages by name', `
    <form class="pkg-form" id="pkg-search-form">
      <input id="pkg-search-query" placeholder="e.g. curl" required />
      <button type="submit">Search</button>
    </form>
    <div id="pkg-search-result" class="muted">No query yet.</div>
    <div id="pkg-search-expanded"></div>
  `);

  const infoView = () => panel('View single package info', `
    <form class="pkg-form" id="pkg-info-form">
      <input id="pkg-info-name" placeholder="e.g. curl-8.8.0" required />
      <button type="submit">Get info</button>
    </form>
    <div id="pkg-info-result" class="muted">No package selected.</div>
  `);

  const whichView = () => panel('Find package owning a file path', `
    <form class="pkg-form" id="pkg-which-form">
      <input id="pkg-which-path" placeholder="e.g. /usr/local/bin/curl" required />
      <button type="submit">Lookup</button>
    </form>
    <div id="pkg-which-result" class="muted">No path provided.</div>
  `);

  const listView = () => panel('List all installed packages', `
    <form class="pkg-form" id="pkg-list-form">
      <button type="submit">Load package list</button>
    </form>
    <div id="pkg-list-result" class="muted">No list loaded.</div>
  `);

  const render = () => {
    if (currentTab === 'search') dashboard.innerHTML = searchView();
    if (currentTab === 'info') dashboard.innerHTML = infoView();
    if (currentTab === 'which') dashboard.innerHTML = whichView();
    if (currentTab === 'list') dashboard.innerHTML = listView();
    bindForms();
  };

  const renderList = (container, items, clickHandler) => {
    if (!items || !items.length) {
      container.innerHTML = '<p class="muted">No results.</p>';
      return;
    }
    container.innerHTML = `<ul class="pkg-list">${items.map((item) => {
      const safe = esc(item);
      const encoded = encodeURIComponent(item);
      const cls = clickHandler ? ` class="pkg-list-button" type="button" data-package="${encoded}"` : '';
      return `<li>${clickHandler ? `<button${cls}><code>${safe}</code></button>` : `<code>${safe}</code>`}</li>`;
    }).join('')}</ul>`;

    if (clickHandler) {
      container.querySelectorAll('.pkg-list-button').forEach((button) => {
        button.addEventListener('click', () => clickHandler(decodeURIComponent(button.dataset.package || '')));
      });
    }
  };

  const renderPackageDetails = async (container, pkgName) => {
    container.innerHTML = '<p class="muted">Loading package info...</p>';
    try {
      const [infoResp, filesResp] = await Promise.all([
        fetch(`/api/packages/info?name=${encodeURIComponent(pkgName)}`),
        fetch(`/api/packages/files?name=${encodeURIComponent(pkgName)}`)
      ]);
      const infoData = await infoResp.json();
      const filesData = await filesResp.json();
      const info = infoData.info || infoData.error || 'No data';
      const files = filesData.files || [];

      container.innerHTML = `
        <div class="pkg-detail panel stat-card">
          <h4><code>${esc(pkgName)}</code></h4>
          <details open>
            <summary>Package information</summary>
            <div class="pkg-output">${esc(info)}</div>
          </details>
          <details>
            <summary>Package files (${files.length})</summary>
            <div class="pkg-files-scroll">
              ${files.length ? `<ul class="pkg-list">${files.map((file) => `<li><code>${esc(file)}</code></li>`).join('')}</ul>` : '<p class="muted">No files returned.</p>'}
            </div>
          </details>
        </div>
      `;
    } catch {
      container.innerHTML = '<p class="muted">Unable to load package details.</p>';
    }
  };

  const bindForms = () => {
    const searchForm = document.getElementById('pkg-search-form');
    const infoForm = document.getElementById('pkg-info-form');
    const whichForm = document.getElementById('pkg-which-form');
    const listForm = document.getElementById('pkg-list-form');

    searchForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const q = document.getElementById('pkg-search-query').value.trim();
      const target = document.getElementById('pkg-search-result');
      const expanded = document.getElementById('pkg-search-expanded');
      if (!q) return;
      expanded.innerHTML = '';
      target.textContent = 'Searching...';
      try {
        const resp = await fetch(`/api/packages/search?q=${encodeURIComponent(q)}`);
        const data = await resp.json();
        renderList(target, data.packages || [], async (pkgName) => {
          target.innerHTML = '';
          await renderPackageDetails(expanded, pkgName);
        });
      } catch {
        target.innerHTML = '<p class="muted">Search failed.</p>';
      }
    });

    infoForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const name = document.getElementById('pkg-info-name').value.trim();
      const target = document.getElementById('pkg-info-result');
      if (!name) return;
      target.textContent = 'Loading package info...';
      try {
        const resp = await fetch(`/api/packages/info?name=${encodeURIComponent(name)}`);
        const data = await resp.json();
        if (!data.found || !data.raw) {
          target.innerHTML = `<p class="muted">Package <code>${esc(name)}</code> not found.</p>`;
          return;
        }
        target.innerHTML = `<div class="pkg-output">${esc(data.raw)}</div>`;
      } catch {
        target.innerHTML = '<p class="muted">Info lookup failed.</p>';
      }
    });

    whichForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const filePath = document.getElementById('pkg-which-path').value.trim();
      const target = document.getElementById('pkg-which-result');
      if (!filePath) return;
      target.textContent = 'Looking up package owner...';
      try {
        const resp = await fetch(`/api/packages/which?path=${encodeURIComponent(filePath)}`);
        const data = await resp.json();
        if (!data.found || !data.raw) {
          target.innerHTML = `<p class="muted">No package owns <code>${esc(filePath)}</code>.</p>`;
          return;
        }
        target.innerHTML = `<div class="pkg-output">${esc(data.raw)}</div>`;
      } catch {
        target.innerHTML = '<p class="muted">Path lookup failed.</p>';
      }
    });

    listForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const target = document.getElementById('pkg-list-result');
      target.textContent = 'Loading installed package list...';
      try {
        const resp = await fetch('/api/packages/list');
        const data = await resp.json();
        renderList(target, data.packages || [], async (pkgName) => {
          await renderPackageDetails(target, pkgName);
        });
      } catch {
        target.innerHTML = '<p class="muted">Unable to load package list.</p>';
      }
    });
  };

  tabs.addEventListener('click', (event) => {
    const button = event.target.closest('.tab-button');
    if (!button) return;
    currentTab = button.dataset.tab;
    tabs.querySelectorAll('.tab-button').forEach((b) => b.classList.toggle('active', b === button));
    render();
  });

  render();
})();
</script>
