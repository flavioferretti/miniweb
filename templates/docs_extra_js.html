<!-- templates/docs_extra_js.html -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sectionsContainer = document.getElementById('sectionsContainer');
    const pagesViewer = document.getElementById('pagesViewer');
    const pagesList = document.getElementById('pagesList');
    const sectionTitle = document.getElementById('currentSectionTitle');
    const searchInput = document.getElementById('manSearch');
    const searchResults = document.getElementById('searchResults');

    let debounceTimer;

    // --- 1. CARICAMENTO SEZIONI (Corretto URL in /api/man/sections) ---
    // --- CARICAMENTO SEZIONI UNIVERSALE ---
    // --- CARICAMENTO DINAMICO AREE ---
    fetch('/api/man/sections')
        .then(res => res.json())
        .then(data => {
            sectionsContainer.innerHTML = '';
            Object.keys(data).forEach(key => {
                const area = data[key];
                const icon = key === 'system' ? 'üîß' : (key === 'x11' ? 'üñ•Ô∏è' : 'üì¶');
                sectionsContainer.innerHTML += `
                    <div class="area-section">
                        <div class="area-header"><h2>${icon} ${area.name}</h2></div>
                        <div class="sections-grid-inner">
                            ${area.sections.map(s => `
                                <div class="section-card" onclick="loadSection('${key}', '${s.id}', '${s.name}')">
                                    <h3>Section ${s.id}</h3><p>${s.name}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            });
        });
    // --- 2. CARICAMENTO PAGINE (Gestisce array di stringhe) ---
    window.loadSection = function(area, id, name) {
        sectionsContainer.classList.add('hidden');
        pagesViewer.classList.remove('hidden');
        sectionTitle.innerHTML = `${area === 'system' ? 'üîß' : 'üì¶'} Section ${id}: ${name}`;
        pagesList.innerHTML = '<div class="loading">Loading...</div>';

        fetch(`/api/man/${area}/${id}`)
            .then(res => res.json())
            .then(data => {
                // 'data.pages' ora √® un array di stringhe ["ls", "cp", ...]
                if (!data.pages || data.pages.length === 0) {
                    pagesList.innerHTML = 'No pages found.';
                    return;
                }

                pagesList.innerHTML = data.pages.map(pageName => `
                    <div class="page-item">
                        <div class="page-header">
                            <strong>${pageName}</strong>
                            <span class="tag">${id}</span>
                        </div>
                        <div class="links">
                            <a href="/man/${area}/${id}/${pageName}" target="_blank">HTML</a>
                            <a href="/man/${area}/${id}/${pageName}.md" target="_blank">MD</a>
                            <a href="/man/${area}/${id}/${pageName}.pdf" target="_blank">PDF</a>
                        </div>
                    </div>
                `).join('');
            });
    };

    // --- 3. RICERCA (Gestisce il formato raw di apropos) ---
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        if (query.length < 2) { searchResults.classList.add('hidden'); return; }

        debounceTimer = setTimeout(() => {
            searchResults.innerHTML = 'Searching...';
            searchResults.classList.remove('hidden');

            // Nota: l'URL nel tuo man.c √® /api/man/search/QUERY non /api/man/search?q=
            // --- LOGICA DI RICERCA AGGIORNATA ---
        fetch(`/api/man/search/${encodeURIComponent(query)}`)
            .then(r => r.text())
            .then(text => {
                const lines = text.split('\n').filter(l => l.trim().length > 0);
                searchResults.innerHTML = lines.map(line => {
                    // Regex pi√π robusta: cattura "nome", "sezione" e "descrizione"
                    const match = line.match(/^([a-zA-Z0-9_.:-]+)\(([^)]+)\)\s+-\s+(.*)$/);
                    if (!match) return '';

                    const name = match[1];
                    const section = match[2];
                    const desc = match[3];

                    // Determiniamo l'area probabile basandoci sulla sezione
                    // Nota: apropos non dice il path, quindi usiamo un fallback intelligente
                    return `
                        <div class="search-item" onclick="window.open('/man/system/${section}/${name}', '_blank')">
                            <span class="tag">${section}</span>
                            <strong>${name}</strong>
                            <span class="desc">${desc}</span>
                        </div>`;
                }).join('');
            });

        }, 300);
    });

    window.closeViewer = function() {
        pagesViewer.classList.add('hidden');
        sectionsContainer.classList.remove('hidden');
    };
});
</script>
